/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package view;

import controller.ControllerEtablissement;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.TreeSet;
import javax.swing.DefaultListModel;
import javax.swing.table.AbstractTableModel;
import javax.swing.table.TableModel;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.TreeModel;
import model.Classe;
import model.Eleve;
import model.Enseignant;

/**
 *
 * @author flemoal
 */
public class VueProviseur extends javax.swing.JFrame {

    private ControllerEtablissement ce;
    private DefaultListModel listeEleves, listeEnseignants;
    private MyTableModel tableEnseignants;

    /**
     * Creates new form VueProviseur
     */
    public VueProviseur(ControllerEtablissement ce) {
        this.ce = ce;
        this.listeEleves = new DefaultListModel();
        this.listeEnseignants = new DefaultListModel();
        this.tableEnseignants = new MyTableModel(this.ce.getEtablissement().getEnseignants(), this);
        initComponents();
        
        this.jPanel1.setVisible(false);
        this.jPanel2.setVisible(false);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jTabbedPane1 = new javax.swing.JTabbedPane();
        jSplitPane1 = new javax.swing.JSplitPane();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTree1 = new javax.swing.JTree();
        jPanelInfos = new javax.swing.JPanel();
        jPanel1 = new javax.swing.JPanel();
        jScrollPane3 = new javax.swing.JScrollPane();
        jListEleves = new javax.swing.JList();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane4 = new javax.swing.JScrollPane();
        jListEnseignants = new javax.swing.JList();
        jPanel3 = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        jPanel4 = new javax.swing.JPanel();
        jButtonDeleteEnseignant = new javax.swing.JButton();
        jButtonAddEnseignant = new javax.swing.JButton();
        jMenuBar1 = new javax.swing.JMenuBar();
        jMenu1 = new javax.swing.JMenu();
        jMenuItem1 = new javax.swing.JMenuItem();
        jMenuItem2 = new javax.swing.JMenuItem();
        jMenu2 = new javax.swing.JMenu();
        jMenuItem3 = new javax.swing.JMenuItem();
        jMenuItem4 = new javax.swing.JMenuItem();
        jMenuItem5 = new javax.swing.JMenuItem();
        jMenu3 = new javax.swing.JMenu();
        jMenuItem6 = new javax.swing.JMenuItem();
        jMenuItem7 = new javax.swing.JMenuItem();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("Gestion de l'établissement - Proviseur");

        jSplitPane1.setDividerLocation(150);
        jSplitPane1.setResizeWeight(0.1);

        jTree1.setModel(getTreeClasses());
        jTree1.setRootVisible(false);
        jTree1.addTreeSelectionListener(new javax.swing.event.TreeSelectionListener() {
            public void valueChanged(javax.swing.event.TreeSelectionEvent evt) {
                jTree1ValueChanged(evt);
            }
        });
        jScrollPane1.setViewportView(jTree1);

        jSplitPane1.setLeftComponent(jScrollPane1);

        jPanelInfos.setLayout(new java.awt.GridLayout(2, 1, 0, 10));

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Élèves"));
        jPanel1.setLayout(new java.awt.BorderLayout());

        jListEleves.setModel(listeEleves);
        jScrollPane3.setViewportView(jListEleves);

        jPanel1.add(jScrollPane3, java.awt.BorderLayout.CENTER);

        jPanelInfos.add(jPanel1);

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Enseignants"));
        jPanel2.setLayout(new java.awt.BorderLayout());

        jListEnseignants.setModel(listeEnseignants);
        jScrollPane4.setViewportView(jListEnseignants);

        jPanel2.add(jScrollPane4, java.awt.BorderLayout.CENTER);

        jPanelInfos.add(jPanel2);

        jSplitPane1.setRightComponent(jPanelInfos);

        jTabbedPane1.addTab("Classes", jSplitPane1);

        jPanel3.setLayout(new java.awt.BorderLayout());

        jTable1.setModel(this.tableEnseignants);
        jScrollPane2.setViewportView(jTable1);

        jPanel3.add(jScrollPane2, java.awt.BorderLayout.CENTER);

        jButtonDeleteEnseignant.setText("Supprimer");
        jButtonDeleteEnseignant.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonDeleteEnseignantActionPerformed(evt);
            }
        });
        jPanel4.add(jButtonDeleteEnseignant);

        jButtonAddEnseignant.setText("Ajouter");
        jButtonAddEnseignant.setToolTipText("");
        jButtonAddEnseignant.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonAddEnseignantActionPerformed(evt);
            }
        });
        jPanel4.add(jButtonAddEnseignant);

        jPanel3.add(jPanel4, java.awt.BorderLayout.SOUTH);

        jTabbedPane1.addTab("Enseignants", jPanel3);

        jMenu1.setText("Fichier");

        jMenuItem1.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_D, java.awt.event.InputEvent.META_MASK));
        jMenuItem1.setText("Déconnexion");
        jMenuItem1.setToolTipText("");
        jMenu1.add(jMenuItem1);

        jMenuItem2.setText("Quitter");
        jMenuItem2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem2ActionPerformed(evt);
            }
        });
        jMenu1.add(jMenuItem2);

        jMenuBar1.add(jMenu1);

        jMenu2.setText("Classe");
        jMenu2.setToolTipText("");

        jMenuItem3.setText("Ajouter une classe");
        jMenuItem3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem3ActionPerformed(evt);
            }
        });
        jMenu2.add(jMenuItem3);

        jMenuItem4.setText("Ajouter un élève");
        jMenuItem4.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem4ActionPerformed(evt);
            }
        });
        jMenu2.add(jMenuItem4);

        jMenuItem5.setText("Affecter un enseignant");
        jMenuItem5.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem5ActionPerformed(evt);
            }
        });
        jMenu2.add(jMenuItem5);

        jMenuBar1.add(jMenu2);

        jMenu3.setText("Enseignants");

        jMenuItem6.setText("Ajouter un enseignant");
        jMenuItem6.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem6ActionPerformed(evt);
            }
        });
        jMenu3.add(jMenuItem6);

        jMenuItem7.setText("Supprimer un enseignant");
        jMenuItem7.setEnabled(false);
        jMenu3.add(jMenuItem7);

        jMenuBar1.add(jMenu3);

        setJMenuBar(jMenuBar1);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jTabbedPane1)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jTabbedPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 347, Short.MAX_VALUE)
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jTree1ValueChanged(javax.swing.event.TreeSelectionEvent evt) {//GEN-FIRST:event_jTree1ValueChanged
        this.refreshClasseInfos();
    }//GEN-LAST:event_jTree1ValueChanged

    private void jMenuItem3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem3ActionPerformed
        new VueAddClasse(this, this.ce).setVisible(true);
    }//GEN-LAST:event_jMenuItem3ActionPerformed

    private void jMenuItem5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem5ActionPerformed
        new VueAffectEnseignant(this, this.ce).setVisible(true);
    }//GEN-LAST:event_jMenuItem5ActionPerformed

    private void jMenuItem2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem2ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jMenuItem2ActionPerformed

    private void jButtonDeleteEnseignantActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonDeleteEnseignantActionPerformed
        List<Enseignant> le = new ArrayList<>();
        for(int i : jTable1.getSelectedRows()) {
            le.add((Enseignant) this.ce.getEtablissement().getEnseignants().toArray()[i]);
        }
        
        this.ce.getEtablissement().getEnseignants().removeAll(le);
        this.tableEnseignants.refresh();
    }//GEN-LAST:event_jButtonDeleteEnseignantActionPerformed

    private void jMenuItem4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem4ActionPerformed
        new VueAddEleve(this, this.ce).setVisible(true);
    }//GEN-LAST:event_jMenuItem4ActionPerformed

    private void jMenuItem6ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem6ActionPerformed
        new VueAddEnseignant(this, this.ce).setVisible(true);
    }//GEN-LAST:event_jMenuItem6ActionPerformed

    private void jButtonAddEnseignantActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonAddEnseignantActionPerformed
        new VueAddEnseignant(this, this.ce).setVisible(true);
    }//GEN-LAST:event_jButtonAddEnseignantActionPerformed

    private TreeModel getTreeClasses() {
        // Racine de l'arbre
        DefaultMutableTreeNode treeRoot = new DefaultMutableTreeNode("Root");
        
        Classe cPrev = null;
        DefaultMutableTreeNode nodeClasse = null;
        
        // Parcours de toutes les classes de l'établissement
        for(Classe cCurr : this.ce.getEtablissement().getClasses()) {
            // Si on entre dans un nouveau niveau de classe alors faire
            // un nouveau niveau et inscrire l'ancien dans la racine
            if (cPrev == null || cCurr.getNiveau() != cPrev.getNiveau()) {
                if (nodeClasse != null) {
                    treeRoot.add(nodeClasse);
                }

                nodeClasse = new DefaultMutableTreeNode(cCurr.getNiveau().getName());
            }
            cPrev = cCurr;
            nodeClasse.add(new DefaultMutableTreeNode(cCurr));
        }

        if (nodeClasse != null) {
            treeRoot.add(nodeClasse);
        }

        return new DefaultTreeModel(treeRoot);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButtonAddEnseignant;
    private javax.swing.JButton jButtonDeleteEnseignant;
    private javax.swing.JList jListEleves;
    private javax.swing.JList jListEnseignants;
    private javax.swing.JMenu jMenu1;
    private javax.swing.JMenu jMenu2;
    private javax.swing.JMenu jMenu3;
    private javax.swing.JMenuBar jMenuBar1;
    private javax.swing.JMenuItem jMenuItem1;
    private javax.swing.JMenuItem jMenuItem2;
    private javax.swing.JMenuItem jMenuItem3;
    private javax.swing.JMenuItem jMenuItem4;
    private javax.swing.JMenuItem jMenuItem5;
    private javax.swing.JMenuItem jMenuItem6;
    private javax.swing.JMenuItem jMenuItem7;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanelInfos;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JSplitPane jSplitPane1;
    private javax.swing.JTabbedPane jTabbedPane1;
    private javax.swing.JTable jTable1;
    private javax.swing.JTree jTree1;
    // End of variables declaration//GEN-END:variables

    public void refreshClasseInfos() {
DefaultMutableTreeNode node = (DefaultMutableTreeNode) jTree1.getLastSelectedPathComponent();
        if (node != null && node.isLeaf()) {
            // Récupération de la classe
            Object nodeInfo = node.getUserObject();
            Classe classe = (Classe) nodeInfo;

            // Effacement des listes
            this.listeEleves.clear();
            this.listeEnseignants.clear();

            // Remplissage de la liste des élèves
            for (Eleve e : classe.getEleves()) {
                this.listeEleves.addElement(e.getPrenom() + " " + e.getNom());
            }

            // Remplissage de la liste des enseignants
            for (Enseignant e : classe.getEnseignants()) {
                // S'agissant d'un tableau il faut ignorer les éléments
                // manquants au cas où
                if (e == null) {
                    continue;
                }

                String text = e.getNom() + " (" + e.getMatiere().getName() + ")";

                // Ajout du gras pour le professeur principal
                if (e.equals(classe.getProfesseurPrincipal())) {
                    text = "<html><b>" + text + "</b></html>";
                }

                this.listeEnseignants.addElement(text);
            }

            // Affichage des listes
            this.jPanel1.setVisible(true);
            this.jPanel2.setVisible(true);

        } else {
            this.jPanel1.setVisible(false);
            this.jPanel2.setVisible(false);
        }
    }

    
    class MyTableModel extends AbstractTableModel {
        private VueProviseur vp;
        private TreeSet<Enseignant> enseignants;
        private String[] columnNames = {"Nom","Prénom","Matière"};
//        private Object[][] data;
        
        public MyTableModel(TreeSet<Enseignant> enseignants, VueProviseur vp) {
//            this.data = new Object[enseignants.size()][3];
            this.enseignants = enseignants;
            this.vp = vp;
            
//            int i = 0;
//            for(Enseignant e : enseignants) {
//                data[i][0] = e.getNom();
//                data[i][1] = e.getPrenom();
//                data[i][2] = e.getMatiere();
//                i++;
//            }
        }

        
        
        public int getColumnCount() {
            return columnNames.length;
        }

        public int getRowCount() {
            return enseignants.size();
        }

        public String getColumnName(int col) {
            return columnNames[col];
        }

        public Object getValueAt(int row, int col) {
//            return data[row][col];
            Enseignant e = (Enseignant) enseignants.toArray()[row];
            switch(col) {
                case 0:
                    return e.getNom();
                case 1:
                    return e.getPrenom();
                case 2:
                    return e.getMatiere();
                default:
                    return null;
            }
        }

        /*
         * JTable uses this method to determine the default renderer/
         * editor for each cell.  If we didn't implement this method,
         * then the last column would contain text ("true"/"false"),
         * rather than a check box.
         */
        public Class getColumnClass(int c) {
            return getValueAt(0, c).getClass();
        }

        /*
         * Don't need to implement this method unless your table's
         * editable.
         */
        public boolean isCellEditable(int row, int col) {
            //Note that the data/cell address is constant,
            //no matter where the cell appears onscreen.
            if (col < 2) {
                return true;
            } else {
                return false;
            }
        }

        /*
         * Don't need to implement this method unless your table's
         * data can change.
         */
        public void setValueAt(Object value, int row, int col) {
//            data[row][col] = value;
//            fireTableCellUpdated(row, col);
//            
            Enseignant e = (Enseignant) enseignants.toArray()[row];
            switch(col) {
                case 0:
                    if(value instanceof String) e.setNom((String) value);
                    break;
                case 1:
                    if(value instanceof String) e.setPrenom((String) value);
                    break;
            }
            
            this.vp.refreshClasseInfos();
        }
        
//        public void removeRow(Integer row) {
//            enseignants.remove((Enseignant) enseignants.toArray()[row]);
//        }
        
        public void refresh() {
            fireTableDataChanged();
        }
    }
}
